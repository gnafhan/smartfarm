services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: livestock-mongodb-prod
    restart: always
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-changeme123}
      MONGO_INITDB_DATABASE: livestock_db
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
      - ./backups/mongodb:/backups
    networks:
      - livestock-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: livestock-redis-prod
    restart: always
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-changeme123}
    volumes:
      - redis_data:/data
    networks:
      - livestock-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Mosquitto MQTT Broker
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: livestock-mosquitto-prod
    restart: always
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/config:/mosquitto/config:ro
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
    networks:
      - livestock-network
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-t", "$$SYS/#", "-C", "1", "-i", "healthcheck", "-W", "3"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Backend API
  backend:
    build:
      context: ./packages/backend
      dockerfile: Dockerfile
      args:
        NODE_ENV: production
    image: livestock-backend:latest
    container_name: livestock-backend-prod
    restart: always
    environment:
      NODE_ENV: production
      PORT: 3001
      
      # Database
      MONGODB_URI: mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD:-changeme123}@mongodb:27017/livestock_db?authSource=admin
      
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-changeme123}
      
      # MQTT
      MQTT_BROKER_URL: mqtt://mosquitto:1883
      MQTT_CLIENT_ID: livestock-backend-prod
      
      # JWT
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      JWT_EXPIRES_IN: 7d
      
      # Email (Optional)
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      SMTP_FROM: ${SMTP_FROM:-noreply@livestock.com}
      
      # CORS
      CORS_ORIGIN: https://${FRONTEND_SUBDOMAIN:-livestock}.${DOMAIN:-localhost}
    volumes:
      - ./logs/backend:/app/logs
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      mosquitto:
        condition: service_healthy
    networks:
      - livestock-network
      - traefik_network
    labels:
      - traefik.enable=true
      - traefik.docker.network=${TRAEFIK_NETWORK:-traefik_network}
      # HTTP Router
      - traefik.http.routers.livestock-backend.rule=Host(`${BACKEND_SUBDOMAIN:-api-livestock}.${DOMAIN:-localhost}`)
      - traefik.http.routers.livestock-backend.entrypoints=web,websecure
      - traefik.http.routers.livestock-backend.tls=true
      - traefik.http.routers.livestock-backend.tls.certresolver=${CERT_RESOLVER:-mytlschallenge}
      - traefik.http.services.livestock-backend.loadbalancer.server.port=3001
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Frontend Web App
  frontend:
    build:
      context: ./packages/frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: https://${BACKEND_SUBDOMAIN:-api-livestock}.${DOMAIN:-localhost}
        NEXT_PUBLIC_WS_URL: https://${BACKEND_SUBDOMAIN:-api-livestock}.${DOMAIN:-localhost}
    image: livestock-frontend:latest
    container_name: livestock-frontend-prod
    restart: always
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: https://${BACKEND_SUBDOMAIN:-api-livestock}.${DOMAIN:-localhost}
      NEXT_PUBLIC_WS_URL: https://${BACKEND_SUBDOMAIN:-api-livestock}.${DOMAIN:-localhost}
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - traefik
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik
      # HTTP Router
      - traefik.http.routers.livestock-frontend.rule=Host(`${FRONTEND_SUBDOMAIN:-livestock}.${DOMAIN:-localhost}`)
      - traefik.http.routers.livestock-frontend.entrypoints=web,websecure
      - traefik.http.routers.livestock-frontend.tls=true
      - traefik.http.routers.livestock-frontend.tls.certresolver=mytlschallenge
      - traefik.http.services.livestock-frontend.loadbalancer.server.port=3000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Nginx Reverse Proxy (Optional - disabled when using external Traefik)
  # Uncomment below if you want to use Nginx instead of Traefik
  # nginx:
  #   image: nginx:alpine
  #   container_name: livestock-nginx-prod
  #   restart: always
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./nginx/ssl:/etc/nginx/ssl:ro
  #     - ./logs/nginx:/var/log/nginx
  #   depends_on:
  #     - frontend
  #     - backend
  #   networks:
  #     - livestock-network
  #   healthcheck:
  #     test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "10m"
  #       max-file: "3"

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  redis_data:
    driver: local
  mosquitto_data:
    driver: local
  mosquitto_log:
    driver: local

networks:
  livestock-network:
    driver: bridge
    internal: true
  traefik_network:
    external: true
    name: ${TRAEFIK_NETWORK:-traefik_network}
